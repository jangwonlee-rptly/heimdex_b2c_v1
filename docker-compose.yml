services:
  # ============================================================================
  # Database - PostgreSQL with pgvector and PGroonga
  # ============================================================================
  db:
    image: pgvector/pgvector:pg16
    container_name: heimdex-db
    environment:
      POSTGRES_DB: heimdex
      POSTGRES_USER: heimdex
      POSTGRES_PASSWORD: heimdex_dev_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init-extensions.sql:/docker-entrypoint-initdb.d/01-init-extensions.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U heimdex"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - heimdex

  # ============================================================================
  # Redis - Cache and Queue Broker
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: heimdex-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - heimdex

  # ============================================================================
  # MinIO - S3-compatible object storage (dev only)
  # ============================================================================
  minio:
    image: minio/minio:latest
    container_name: heimdex-minio
    command: server /data --console-address ":9001" --address ":9000"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_DOMAIN: localhost
      MINIO_SERVER_URL: http://localhost:9000
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - heimdex

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: heimdex-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing local/uploads;
      mc mb --ignore-existing local/sidecars;
      mc mb --ignore-existing local/thumbnails;
      mc mb --ignore-existing local/tmp;
      mc anonymous set none local/uploads;
      mc anonymous set none local/sidecars;
      mc anonymous set none local/thumbnails;
      mc anonymous set none local/tmp;
      echo 'MinIO buckets initialized';
      "
    networks:
      - heimdex
    restart: "no"

  # ============================================================================
  # Database Migrations - Run Alembic migrations automatically
  # ============================================================================
  db-migrate:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: heimdex-db-migrate
    env_file:
      - .env.local
    environment:
      POSTGRES_URL: postgresql://heimdex:heimdex_dev_pass@db:5432/heimdex
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_DB: heimdex
      POSTGRES_USER: heimdex
      POSTGRES_PASSWORD: heimdex_dev_pass
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./db:/db
      - ./api:/app
    working_dir: /db
    command: >
      bash -c "
      echo 'Waiting for database to be ready...';
      sleep 5;
      echo 'Running database migrations...';
      alembic upgrade head;
      echo 'Migrations complete!';
      "
    networks:
      - heimdex
    restart: "no"

  # ============================================================================
  # Model Downloader - Download ML models automatically
  # ============================================================================
  model-downloader:
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    container_name: heimdex-model-downloader
    environment:
      # Model configuration
      MODELS_DIR: /app/models
      ASR_MODEL: ${ASR_MODEL:-medium}
      VISION_MODEL_NAME: ${VISION_MODEL_NAME:-google/siglip-so400m-patch14-384}
      LOAD_BGE_M3: ${LOAD_BGE_M3:-false}
      FEATURE_FACE: ${FEATURE_FACE:-false}
      # Unified cache configuration (shared across all ML frameworks)
      HF_HOME: /app/models/.cache
      HF_HUB_CACHE: /app/models/.cache
      XDG_CACHE_HOME: /app/models/.cache  # For Whisper
      # Suppress warnings
      PYTHONWARNINGS: ignore::FutureWarning
    volumes:
      - models_cache:/app/models
      - ./scripts:/scripts
    command: >
      bash -c "
      chmod +x /scripts/download_models.sh;
      /scripts/download_models.sh;
      "
    restart: "no"

  # ============================================================================
  # Model Service - Centralized ML Inference
  # ============================================================================
  model-service:
    build:
      context: ./model-service
      dockerfile: Dockerfile
    container_name: heimdex-model-service
    environment:
      # Model configuration
      MODELS_DIR: /app/models
      ASR_MODEL: ${ASR_MODEL:-medium}
      VISION_MODEL_NAME: ${VISION_MODEL_NAME:-google/siglip-so400m-patch14-384}
      LOAD_BGE_M3: ${LOAD_BGE_M3:-false}  # Optional: BGE-M3 text embeddings
      FEATURE_FACE: ${FEATURE_FACE:-false}
      # Inference configuration
      BATCH_SIZE: ${MODEL_BATCH_SIZE:-4}
      BATCH_TIMEOUT_MS: ${MODEL_BATCH_TIMEOUT_MS:-100}
      # Unified cache configuration (MUST match model-downloader)
      HF_HOME: /app/models/.cache
      HF_HUB_CACHE: /app/models/.cache
      XDG_CACHE_HOME: /app/models/.cache  # For Whisper
      # GPU configuration
      CUDA_VISIBLE_DEVICES: "0"
      # Prevent auto-downloads (fail fast if models missing)
      HF_HUB_OFFLINE: "1"
      TRANSFORMERS_OFFLINE: "1"
      # Suppress warnings
      PYTHONWARNINGS: ignore::FutureWarning
    ports:
      - "8001:8001"  # Internal inference endpoint
    volumes:
      - ./model-service:/app
      - models_cache:/app/models:ro  # Read-only for safety
    depends_on:
      model-downloader:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G  # Optimized: Whisper 2.9GB + SigLIP 1.6GB + overhead
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s  # Models take time to load from cache
    networks:
      - heimdex
    restart: unless-stopped

  # ============================================================================
  # API - FastAPI Backend
  # ============================================================================
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: heimdex-api
    env_file:
      - .env.local
    environment:
      POSTGRES_URL: postgresql://heimdex:heimdex_dev_pass@db:5432/heimdex
      POSTGRES_HOST: db
      REDIS_HOST: redis
      REDIS_URL: redis://redis:6379/0
      MINIO_ENDPOINT: localhost:9000
      MINIO_EXTERNAL_ENDPOINT: localhost:9000
      MODEL_SERVICE_URL: http://model-service:8001
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      model-service:
        condition: service_healthy
      db-migrate:
        condition: service_completed_successfully
      minio-init:
        condition: service_completed_successfully
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G  # Reduced - no models loaded
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - heimdex

  # ============================================================================
  # Worker - Background Processing
  # ============================================================================
  worker:
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    container_name: heimdex-worker
    env_file:
      - .env.local
    environment:
      POSTGRES_URL: postgresql://heimdex:heimdex_dev_pass@db:5432/heimdex
      POSTGRES_HOST: db
      REDIS_HOST: redis
      REDIS_URL: redis://redis:6379/0
      MINIO_ENDPOINT: localhost:9000
      MINIO_EXTERNAL_ENDPOINT: localhost:9000
      MODEL_SERVICE_URL: http://model-service:8001
    extra_hosts:
      - "localhost:host-gateway"
    volumes:
      - ./worker:/app
      - worker_tmp:/tmp/heimdex
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      model-service:
        condition: service_healthy
      db-migrate:
        condition: service_completed_successfully
    command: dramatiq tasks.video_processor tasks.face_processor tasks.indexing tasks.asr tasks.vision tasks.faces --processes 1 --threads 8
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G  # Reduced - no models loaded, single process
    networks:
      - heimdex

  # ============================================================================
  # Web - Next.js Frontend
  # ============================================================================
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: development
    container_name: heimdex-web
    env_file:
      - ./web/.env.local
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NODE_ENV: development
    ports:
      - "3000:3000"
    volumes:
      - ./web:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      api:
        condition: service_healthy
    networks:
      - heimdex

  # ============================================================================
  # Prometheus - Metrics Collection (Optional)
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: heimdex-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - heimdex
    profiles:
      - monitoring

  # ============================================================================
  # Grafana - Metrics Visualization (Optional)
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: heimdex-grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - heimdex
    profiles:
      - monitoring

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  models_cache:
    driver: local
  worker_tmp:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  heimdex:
    driver: bridge
