# Devlog: Added Missing thumbnail_key Column to scenes Table
Date: 2025-11-12 14:18
Session Type: Bug Fix
Status: ‚úÖ RESOLVED

## Session Overview

Added missing `thumbnail_key` column to the `scenes` table in the database. The Scene ORM model expected this column but it didn't exist in the database schema, causing queries to fail when trying to fetch video thumbnails.

### Files Modified
None (database schema change only)

### Database Changes
- Added `thumbnail_key VARCHAR(512)` column to `scenes` table

## Issue Encountered

### Error Message
```
ERROR: column scenes.thumbnail_key does not exist at character 360
```

### Context
- User accessed `/videos` endpoint to list videos
- API tried to fetch first scene thumbnail for each video
- Query included `scenes.thumbnail_key` column
- PostgreSQL rejected query because column doesn't exist
- Request succeeded but thumbnails couldn't be loaded

### SQL Query That Failed
```sql
SELECT scenes.scene_id, scenes.video_id, ..., scenes.thumbnail_key
FROM scenes
JOIN (SELECT scenes.video_id AS video_id, min(scenes.start_s) AS min_start
      FROM scenes
      WHERE scenes.video_id IN ($1::UUID) AND scenes.thumbnail_key IS NOT NULL
      GROUP BY scenes.video_id) AS anon_1
ON scenes.video_id = anon_1.video_id AND scenes.start_s = anon_1.min_start
```

## Root Cause Analysis

### The Problem

**Scene ORM Model** (api/app/models/scene.py:30):
```python
# Thumbnail fields (from migration 20251112_0200_006_add_scene_thumbnails.py)
thumbnail_key = Column(String(512), nullable=True)
```

**Database Schema** (db/create_schema.sql:47-59):
```sql
CREATE TABLE scenes (
    scene_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    video_id UUID NOT NULL REFERENCES videos(video_id) ON DELETE CASCADE,
    start_s NUMERIC(10, 3) NOT NULL,
    end_s NUMERIC(10, 3) NOT NULL,
    transcript TEXT,
    tsv TSVECTOR,
    text_vec VECTOR(1024),
    image_vec VECTOR(1152),
    vision_tags JSONB,
    sidecar_key VARCHAR(512),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
    -- NO thumbnail_key!
);
```

The model references a migration `20251112_0200_006_add_scene_thumbnails.py` that adds `thumbnail_key`, but this migration was never run on the database. The database was created fresh from `create_schema.sql` which doesn't include the column.

### Why This Column Exists in Model

The comment in scene.py says:
```python
# Thumbnail fields (from migration 20251112_0200_006_add_scene_thumbnails.py)
```

This suggests the column was added in a later migration, but since the database was created from a SQL schema file instead of running migrations, this column never made it into the actual database.

### Pattern of Schema Mismatches

This is the **THIRD schema mismatch** we've encountered in this session:

1. **Video metadata** (devlog 2511121357.txt)
   - Model expected: `videos.title`, `videos.description`
   - Database has: Separate `video_metadata` table
   - Fix: Created VideoMetadata model

2. **Enum type names** (devlog 2511121410.txt)
   - Model expected: `videostate`, `usertier`
   - Database has: `video_state`, `user_tier`
   - Fix: Added `name=` parameter to enums

3. **Scene thumbnails** (this devlog)
   - Model expected: `scenes.thumbnail_key`
   - Database has: No such column
   - Fix: Added column to database

**Root cause of all three:** Database created from `db/create_schema.sql` but models reconstructed from migration files. These two sources of truth are out of sync.

## Solution

### Changes Made

Added the missing column to the database:

```sql
ALTER TABLE scenes ADD COLUMN IF NOT EXISTS thumbnail_key VARCHAR(512);
```

### Why Add Column (vs Remove from Model)

I chose to add the column to the database rather than remove it from the model because:

1. **Thumbnails are actively used:** The video routes query for thumbnails to display in the UI
2. **Model is correct:** The Scene model properly represents the intended schema
3. **Database was incomplete:** The schema file was missing this column
4. **Forward compatibility:** Worker will generate thumbnails and store keys in this column

### Verification

1. Added column:
   ```bash
   docker compose exec db psql -U heimdex -d heimdex -c "ALTER TABLE scenes ADD COLUMN IF NOT EXISTS thumbnail_key VARCHAR(512);"
   ```

2. Verified column exists:
   ```sql
   \d scenes
   ```
   Result: `thumbnail_key | character varying(512)`

3. Confirmed API healthy:
   ```bash
   curl http://localhost:8000/health
   ```
   Result: `{"status": "healthy", ...}`

4. Verified worker has matching model:
   ```bash
   docker compose exec worker grep thumbnail_key /app/app/models/scene.py
   ```
   Result: `thumbnail_key = Column(String(512), nullable=True)`

## How Thumbnails Work

### Video Processing Pipeline

1. **Video uploaded** ‚Üí state: `uploading`
2. **Worker processes video** ‚Üí state: `processing`
   - Detects scenes
   - Extracts representative frame for each scene
   - Uploads frame to S3/MinIO
   - Stores object key in `scenes.thumbnail_key`
3. **Video indexed** ‚Üí state: `indexed`

### Thumbnail Display

When listing videos:
1. API queries for first scene of each video that has a thumbnail
2. Generates presigned URL for the thumbnail image
3. Returns URL in video response
4. Frontend displays thumbnail

### Query Logic

```python
# Get first scene with thumbnail for each video
min_start_subq = (
    select(Scene.video_id, func.min(Scene.start_s).label('min_start'))
    .where(
        Scene.video_id.in_(video_ids),
        Scene.thumbnail_key.isnot(None)  # Only scenes with thumbnails
    )
    .group_by(Scene.video_id)
    .subquery()
)

# Get the scene record
scenes_stmt = (
    select(Scene)
    .join(min_start_subq, ...)
)
```

This finds the earliest scene in each video that has a thumbnail stored.

## Key Patterns Learned

### 1. Column Existence Checks

When adding columns to production databases, use `IF NOT EXISTS`:

```sql
-- Safe - won't error if column already exists
ALTER TABLE scenes ADD COLUMN IF NOT EXISTS thumbnail_key VARCHAR(512);

-- Unsafe - errors if column exists
ALTER TABLE scenes ADD COLUMN thumbnail_key VARCHAR(512);
```

### 2. Schema Inspection

Quick ways to check if column exists:

**In psql:**
```sql
\d table_name
```

**Via SQL:**
```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'scenes' AND column_name = 'thumbnail_key';
```

**Via ORM introspection:**
```python
from sqlalchemy import inspect
inspector = inspect(engine)
columns = [c['name'] for c in inspector.get_columns('scenes')]
print('thumbnail_key' in columns)
```

### 3. Migration vs Schema File

Our project has both:
- **Migration files:** `db/migrations/versions/*.py`
- **Schema SQL file:** `db/create_schema.sql`

**Problem:** These are separate sources of truth that can diverge.

**When migrations work well:**
- ‚úì Development: Incremental schema changes
- ‚úì Production: Version-controlled schema evolution
- ‚úì Rollback: Can revert changes

**When schema SQL works well:**
- ‚úì Fresh deploys: Fast database creation
- ‚úì Testing: Consistent baseline schema
- ‚úì Documentation: Single source of truth

**Our situation:** We're using the SQL schema file but models reference migrations. This creates mismatches.

### 4. Finding Schema Mismatches

Systematic approach to find all mismatches:

```python
# Compare ORM models to database schema
from sqlalchemy import inspect

inspector = inspect(engine)

# For each model
for table_name in Base.metadata.tables.keys():
    model_columns = Base.metadata.tables[table_name].columns.keys()
    db_columns = [c['name'] for c in inspector.get_columns(table_name)]

    missing_in_db = set(model_columns) - set(db_columns)
    extra_in_db = set(db_columns) - set(model_columns)

    if missing_in_db:
        print(f"{table_name}: Missing in DB: {missing_in_db}")
    if extra_in_db:
        print(f"{table_name}: Extra in DB: {extra_in_db}")
```

## Related Devlogs

**Schema mismatch fixes in this session:**
1. devlogs/2511121357.txt - Fixed video metadata schema (separate table)
2. devlogs/2511121407.txt - Updated routes for VideoMetadata
3. devlogs/2511121410.txt - Fixed enum type names
4. devlogs/2511121418.txt - Added thumbnail_key column (this devlog)

**Other recent fixes:**
- devlogs/2511121347.txt - Fixed enum values_callable
- devlogs/2511121415.txt - Fixed worker missing models

## Recommendations

### 1. Choose Single Source of Truth

**Option A: Use migrations**
- Delete `create_schema.sql`
- Always use Alembic migrations
- Add migration runner to container startup
- Benefits: Version control, rollback capability

**Option B: Use schema SQL file**
- Delete migration files (or mark as reference only)
- Update `create_schema.sql` with all columns
- Manually sync when models change
- Benefits: Fast setup, clear documentation

**Option C: Generate SQL from migrations**
- Run all migrations on fresh DB
- Export schema: `pg_dump --schema-only`
- Use exported SQL as `create_schema.sql`
- Keep both in sync via automation

### 2. Add Schema Validation Test

Create a test that compares ORM models to database schema:

```python
def test_schema_matches_models():
    """Verify database schema matches ORM models."""
    from sqlalchemy import inspect

    inspector = inspect(engine)

    for table_name, table in Base.metadata.tables.items():
        # Check table exists
        assert inspector.has_table(table_name), f"Table {table_name} missing"

        # Check columns match
        model_columns = set(table.columns.keys())
        db_columns = set(c['name'] for c in inspector.get_columns(table_name))

        assert model_columns == db_columns, \
            f"{table_name}: Model={model_columns}, DB={db_columns}"
```

Run this in CI/CD to catch schema drift early.

### 3. Update create_schema.sql

Add the missing column to the schema file so fresh deploys have it:

```sql
-- Scenes table
CREATE TABLE scenes (
    ...
    sidecar_key VARCHAR(512),
    thumbnail_key VARCHAR(512),  -- ADD THIS LINE
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

## Status

**Issue**: ‚úÖ RESOLVED
**Risk Level**: üü¢ LOW - Simple column addition
**Confidence**: üü¢ HIGH - Column verified in database

**Testing Status**:
- ‚úÖ Column added to database
- ‚úÖ API healthy
- ‚úÖ Worker has matching model
- ‚è≥ Video processing with thumbnails (requires test upload)

## Next Steps for User

1. **Upload a new video** to test end-to-end processing
2. **Monitor worker logs** to see thumbnail generation
3. **Check video list** to see if thumbnails appear
4. **Update create_schema.sql** to include thumbnail_key (prevents future mismatches)

## Known Remaining Issues

### Vector Dimension Mismatch

From the schema dump, I noticed:
- **Model expects:** `text_vec VECTOR(1152)`, `image_vec VECTOR(1152)` (scene.py:23-24)
- **Database has:** `text_vec VECTOR(1024)`, `image_vec VECTOR(1152)`

The `text_vec` dimension is mismatched (1024 vs 1152). This might cause issues during embedding storage. Need to verify if this is intentional or another schema mismatch.

### Potential Face Model Issues

The ScenePerson model references `face_profiles.person_id` but the database might have `face_profiles.face_profile_id` instead. Need to verify face-related table schemas.

## Lessons Learned

### 1. Schema Files Become Stale

When using SQL schema files for database creation:
- Must manually update when models change
- Easy to forget to add new columns
- No automatic synchronization
- Migrations don't apply to schema file

**Solution:** Generate schema file from migrations or use migrations exclusively.

### 2. Comments in Code Are Hints

The comment in scene.py was helpful:
```python
# Thumbnail fields (from migration 20251112_0200_006_add_scene_thumbnails.py)
```

This told us:
- When the field was added (recent migration)
- Why it might be missing (migration not in schema file)
- What to search for (migration file name)

Always document significant schema changes in code comments.

### 3. IF NOT EXISTS Is Your Friend

Using `IF NOT EXISTS` makes database alterations idempotent:
- Safe to run multiple times
- Won't error if already applied
- Good for manual fixes
- Essential for migration scripts

### 4. Systematic Schema Audit Needed

We've found three schema mismatches by encountering errors. There may be more waiting to cause issues. A systematic audit (comparing all ORM models to database schema) would find them proactively.

---

End of Devlog
