# Devlog: Fixed PostgreSQL Enum Type Name Mismatch
Date: 2025-11-12 14:10
Session Type: Bug Fix
Status: ‚úÖ RESOLVED

## Session Overview

Fixed mismatch between PostgreSQL enum type names in database (snake_case) and SQLAlchemy auto-generated names (lowercase). Added explicit `name` parameter to all Enum columns to match database enum types.

### Files Modified
- api/app/models/user.py
- api/app/models/video.py
- api/app/models/job.py

## Issue Encountered

### Error Message
```
asyncpg.exceptions.UndefinedObjectError: type "videostate" does not exist
```

### Context
- User attempted to upload a video via `/videos/upload/init` endpoint
- Code tried to create Video object with `state=VideoState.UPLOADING`
- SQLAlchemy tried to use PostgreSQL enum type named `videostate`
- Database only has enum type named `video_state` (with underscore)
- Upload failed with 500 Internal Server Error

### Stack Trace Location
```
File "/usr/local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 526, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
...
asyncpg.exceptions.UndefinedObjectError: type "videostate" does not exist
```

## Root Cause Analysis

### The Problem

When you define an Enum column in SQLAlchemy without specifying the `name` parameter, SQLAlchemy **auto-generates** a PostgreSQL enum type name by converting the Python enum class name to lowercase:

- `UserTier` ‚Üí `usertier`
- `VideoState` ‚Üí `videostate`
- `JobStage` ‚Üí `jobstage`
- `JobState` ‚Üí `jobstate`

But our database (from db/create_schema.sql) uses **snake_case** naming convention:

```sql
-- Lines 3-7 in db/create_schema.sql
CREATE TYPE user_tier AS ENUM ('free', 'pro', 'enterprise');
CREATE TYPE video_state AS ENUM ('uploading', 'validating', 'processing', 'indexed', 'failed', 'deleted');
CREATE TYPE job_stage AS ENUM ('upload_validate', 'audio_extract', 'asr_fast', 'scene_detect', 'align_merge', 'embed_text', 'vision_sample_frames', 'vision_embed_frames', 'vision_affect_tags', 'faces_enroll_match', 'sidecar_build', 'commit');
CREATE TYPE job_state AS ENUM ('pending', 'running', 'completed', 'failed', 'cancelled');
```

### Why This Happened

1. **Database created from schema file:** db/create_schema.sql defines enum types with snake_case names (e.g., `video_state`)

2. **ORM models didn't specify type name:** When we added `values_callable` in devlog 2511121347.txt, we didn't add the `name` parameter

3. **SQLAlchemy default behavior:** Without `name` parameter, SQLAlchemy auto-generates type name from Python class name (e.g., `VideoState` ‚Üí `videostate`)

4. **First time creating records:** Previous errors occurred on queries (SELECT), which don't validate enum types as strictly. This error occurred during INSERT, which requires the exact enum type to exist.

### Naming Convention Mismatch

**Database:** snake_case
- `user_tier`
- `video_state`
- `job_stage`
- `job_state`

**SQLAlchemy auto-generated:** lowercase (no separators)
- `usertier`
- `videostate`
- `jobstage`
- `jobstate`

This is a common issue when using PostgreSQL enums - you must explicitly specify the type name.

## Solution

### Changes Made

Added `name='<db_enum_type>'` parameter to all Enum columns in ORM models to match database enum type names.

**1. User model (api/app/models/user.py:32)**

BEFORE:
```python
tier = Column(
    Enum(UserTier, values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    server_default="free"
)
```

AFTER:
```python
tier = Column(
    Enum(UserTier, name='user_tier', values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    server_default="free"
)
```

**2. Video model (api/app/models/video.py:34)**

BEFORE:
```python
state = Column(
    Enum(VideoState, values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    server_default="uploading",
    index=True
)
```

AFTER:
```python
state = Column(
    Enum(VideoState, name='video_state', values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    server_default="uploading",
    index=True
)
```

**3. Job model (api/app/models/job.py:45, 49)**

BEFORE:
```python
stage = Column(
    Enum(JobStage, values_callable=lambda obj: [e.value for e in obj]),
    nullable=False
)
state = Column(
    Enum(JobState, values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    server_default="pending",
    index=True
)
```

AFTER:
```python
stage = Column(
    Enum(JobStage, name='job_stage', values_callable=lambda obj: [e.value for e in obj]),
    nullable=False
)
state = Column(
    Enum(JobState, name='job_state', values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    server_default="pending",
    index=True
)
```

### Verification

1. Restarted API:
   ```bash
   docker compose restart api
   ```

2. Confirmed startup successful:
   ```
   {"event": "Application startup complete", "level": "info", ...}
   ```

3. Verified health check:
   ```bash
   curl http://localhost:8000/health
   {"status": "healthy", "version": "0.1.0", ...}
   ```

4. Video upload endpoint should now work ‚úì

## Key Patterns Learned

### 1. SQLAlchemy Enum Name Parameter

When using PostgreSQL enums with SQLAlchemy, you MUST specify the `name` parameter if your database enum type name doesn't match Python's lowercase conversion:

```python
# ‚ùå WRONG - SQLAlchemy auto-generates "videostate"
state = Column(Enum(VideoState), ...)

# ‚úÖ CORRECT - Explicitly specify database type name
state = Column(Enum(VideoState, name='video_state'), ...)
```

### 2. PostgreSQL Enum Types

PostgreSQL has **user-defined enum types** that must exist before they can be used:

```sql
-- Create the type first
CREATE TYPE video_state AS ENUM ('uploading', 'processing', 'indexed');

-- Then use it in a table
CREATE TABLE videos (
    state video_state NOT NULL
);
```

SQLAlchemy must reference the **exact type name** when creating or querying tables with enum columns.

### 3. Enum Type Name Discovery

To find what enum types exist in PostgreSQL:

```sql
-- List all enum types
\dT

-- Show enum values for a specific type
SELECT enumlabel FROM pg_enum
JOIN pg_type ON pg_enum.enumtypid = pg_type.oid
WHERE pg_type.typname = 'video_state';
```

Or check the schema SQL file if you have one.

### 4. Python Enum vs Database Enum

Two separate concepts that must align:

**Python Enum (in code):**
```python
class VideoState(str, enum.Enum):
    UPLOADING = "uploading"    # Name: UPLOADING, Value: "uploading"
    PROCESSING = "processing"
    INDEXED = "indexed"
```

**PostgreSQL Enum Type (in database):**
```sql
CREATE TYPE video_state AS ENUM ('uploading', 'processing', 'indexed');
```

**SQLAlchemy mapping (in ORM):**
```python
state = Column(
    Enum(VideoState,                              # Python enum class
         name='video_state',                       # PostgreSQL type name
         values_callable=lambda obj: [e.value for e in obj]),  # Use enum VALUES
    ...
)
```

Three things must align:
1. **Type name:** `name='video_state'` must match PostgreSQL type
2. **Values:** `values_callable` uses Python enum VALUES ('uploading'), not names ('UPLOADING')
3. **Allowed values:** PostgreSQL enum values must match Python enum values

### 5. When Auto-Generated Names Work

SQLAlchemy's auto-generated names work fine if you use lowercase Python enum class names:

```python
# This would work without name parameter
class videostate(str, enum.Enum):  # Lowercase class name
    UPLOADING = "uploading"

state = Column(Enum(videostate), ...)  # Auto-generates "videostate" type name
```

But this violates Python naming conventions (classes should be PascalCase). Better to:
- Use PascalCase Python class names (VideoState)
- Explicitly specify database type name (name='video_state')

### 6. Enum Parameters Summary

Complete Enum column definition with all parameters:

```python
from sqlalchemy import Column, Enum
import enum

class VideoState(str, enum.Enum):
    UPLOADING = "uploading"
    PROCESSING = "processing"

state = Column(
    Enum(
        VideoState,                                    # Python enum class
        name='video_state',                            # PostgreSQL type name (must match DB)
        values_callable=lambda obj: [e.value for e in obj],  # Use VALUES not NAMES
        create_constraint=True,                        # Create CHECK constraint (optional)
        native_enum=True,                              # Use PostgreSQL native enum (default)
    ),
    nullable=False,
    server_default="uploading",                        # Must be a valid enum value
    index=True
)
```

**Key parameters:**
- `name`: PostgreSQL enum type name (REQUIRED if type name ‚â† lowercase class name)
- `values_callable`: Function to extract values from enum (REQUIRED if using str enum with custom values)
- `create_constraint`: Whether to create CHECK constraint
- `native_enum`: Whether to use PostgreSQL native enum (vs CHECK constraint)

## Related Devlogs

**Progression of enum fixes:**
1. devlogs/2511121347.txt - Fixed enum VALUES (added values_callable)
2. devlogs/2511121410.txt - Fixed enum TYPE NAMES (added name parameter) - **THIS DEVLOG**

**Related context:**
- devlogs/2511121357.txt - VideoMetadata model creation
- devlogs/2511121407.txt - Route handler updates for VideoMetadata

## Lessons Learned

### 1. Two Separate Enum Issues

We actually had TWO distinct enum problems:

**Issue 1 (devlog 2511121347.txt):** Enum VALUES mismatch
- **Problem:** SQLAlchemy using enum NAMES ('FREE') instead of VALUES ('free')
- **Solution:** Add `values_callable=lambda obj: [e.value for e in obj]`

**Issue 2 (this devlog):** Enum TYPE NAME mismatch
- **Problem:** SQLAlchemy looking for type 'videostate' instead of 'video_state'
- **Solution:** Add `name='video_state'`

Both parameters are needed for our setup!

### 2. Different Errors for Different Operations

- **SELECT queries:** Can work even with wrong type name (PostgreSQL is lenient)
- **INSERT operations:** Strict validation - type name must exist exactly
- **This is why** we didn't see this error until trying to create a video

### 3. Check Database Schema First

When getting "type does not exist" errors:
1. ‚úÖ Check what enum types actually exist: `\dT` in psql
2. ‚úÖ Check the schema SQL file if available
3. ‚úÖ Compare database type names to SQLAlchemy `name` parameters
4. ‚ùå Don't assume SQLAlchemy auto-generated names match

### 4. Naming Convention Consistency

Our project uses different naming conventions in different places:
- **Database objects:** snake_case (video_state, user_tier)
- **Python classes:** PascalCase (VideoState, UserTier)
- **Python variables:** snake_case (user_id, video_id)

This is **normal and correct**! Just need to explicitly map between them in ORM.

### 5. Complete Enum Checklist

When defining enum columns in SQLAlchemy with PostgreSQL:

- [ ] Python enum class defined with str values
- [ ] PostgreSQL enum type created in database
- [ ] `Enum()` column in ORM model
- [ ] `name` parameter matches database type name
- [ ] `values_callable` extracts enum values correctly
- [ ] `server_default` is a valid enum value
- [ ] Database enum values match Python enum values

## Status

**Issue**: ‚úÖ RESOLVED
**Risk Level**: üü¢ LOW - Standard PostgreSQL enum configuration
**Confidence**: üü¢ HIGH - API starts successfully, health check passes

**Testing Status**:
- ‚úÖ API starts without errors
- ‚úÖ Health check passes
- ‚è≥ Video upload (requires user testing)
- ‚è≥ User registration/login (requires user testing)
- ‚è≥ Job creation (requires video processing testing)

## Next Steps for User

1. Try uploading a video with title and description
2. Try user registration/login (tests UserTier enum)
3. Monitor API logs for any remaining enum-related errors
4. If video upload succeeds, check job processing (tests JobStage/JobState enums)

## Technical Debt Resolved

**Resolved:**
- ‚úÖ Enum values mapping (devlog 2511121347.txt)
- ‚úÖ Enum type names (this devlog)
- ‚úÖ All enum columns now properly configured

**Remaining:**
- ‚ö†Ô∏è Migration files vs schema SQL file mismatch (from devlog 2511121357.txt)
- ‚ö†Ô∏è No automated enum validation test

## Recommended Testing

To verify all enum types work:

1. **Test UserTier enum:**
   ```bash
   POST /auth/register
   {
     "email": "test@example.com",
     "password": "testpass123"
   }
   # Should create user with default tier='free'
   ```

2. **Test VideoState enum:**
   ```bash
   POST /videos/upload/init
   {
     "filename": "test.mp4",
     "mime_type": "video/mp4",
     "size_bytes": 1024000
   }
   # Should create video with state='uploading'
   ```

3. **Test JobStage/JobState enums:**
   ```bash
   POST /videos/upload/complete
   {
     "video_id": "<video_id>"
   }
   # Should create job with stage='upload_validate' and state='pending'
   ```

---

End of Devlog
