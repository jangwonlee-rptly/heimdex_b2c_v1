# Heimdex B2C Environment Configuration

# ============================================================================
# Database
# ============================================================================
POSTGRES_URL=postgresql://heimdex:heimdex_dev_pass@localhost:5432/heimdex
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=heimdex
POSTGRES_USER=heimdex
POSTGRES_PASSWORD=heimdex_dev_pass

# ============================================================================
# Redis
# ============================================================================
REDIS_URL=redis://localhost:6379/0
REDIS_HOST=localhost
REDIS_PORT=6379

# ============================================================================
# Object Storage (MinIO for dev, GCS for prod)
# ============================================================================
STORAGE_BACKEND=minio  # minio or gcs
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_SECURE=false

# GCS settings (prod)
GCS_PROJECT_ID=heimdex-prod
GCS_BUCKET_UPLOADS=heimdex-uploads
GCS_BUCKET_SIDECARS=heimdex-sidecars
GCS_BUCKET_TMP=heimdex-tmp

# Bucket names (used by both MinIO and GCS)
STORAGE_BUCKET=uploads
STORAGE_BUCKET_SIDECARS=sidecars
STORAGE_BUCKET_TMP=tmp

# ============================================================================
# Supabase Authentication
# ============================================================================
# Get these from your Supabase project settings:
# https://app.supabase.com/project/_/settings/api
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-public-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key  # Optional, for admin operations
SUPABASE_JWT_SECRET=your-jwt-secret  # Found in Settings > API > JWT Secret

# ============================================================================
# Legacy Authentication & JWT (deprecated, now handled by Supabase)
# ============================================================================
# JWT_SECRET_KEY=your-secret-key-change-this-in-production-min-32-chars
# JWT_ALGORITHM=HS256
# JWT_ACCESS_TOKEN_EXPIRE_MINUTES=15
# JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
# JWT_ISSUER=heimdex-b2c
# JWT_AUDIENCE=heimdex-users

# For RS256 (production recommended)
# JWT_ALGORITHM=RS256
# JWT_PRIVATE_KEY_PATH=/secrets/jwt_private_key.pem
# JWT_PUBLIC_KEY_PATH=/secrets/jwt_public_key.pem

# Password hashing (Argon2id) - deprecated, now handled by Supabase
# PASSWORD_HASH_TIME_COST=2
# PASSWORD_HASH_MEMORY_COST=65536  # 64 MB
# PASSWORD_HASH_PARALLELISM=4

# ============================================================================
# Email (for verification & magic links)
# ============================================================================
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=noreply@heimdex.example
SMTP_PASSWORD=your-smtp-password
SMTP_FROM=Heimdex <noreply@heimdex.example>
SMTP_TLS=true

# ============================================================================
# Application URLs
# ============================================================================
API_BASE_URL=http://localhost:8000
FRONTEND_BASE_URL=http://localhost:3000

# ============================================================================
# Feature Flags
# ============================================================================
FEATURE_VISION=true
FEATURE_FACE=false
FEATURE_FACE_LICENSED=false  # Must remain false unless InsightFace license obtained
FEATURE_EMAIL_VERIFICATION=false  # Set true in production

# ============================================================================
# ML Models Configuration
# ============================================================================
# ASR
ASR_MODEL=whisper-medium  # whisper-small, whisper-medium, whisper-large-v3
ASR_DEVICE=cpu  # cpu or cuda
ASR_COMPUTE_TYPE=float32  # float32, float16, int8
WHISPERX_ALIGN=true
WHISPERX_BATCH_SIZE=16

# Text Embeddings
TEXT_MODEL=bge-m3
TEXT_EMBEDDING_DIM=1024
TEXT_DEVICE=cpu

# Vision Embeddings
VISION_MODEL=openclip  # openclip or siglip2
VISION_CLIP_MODEL=ViT-B-32
VISION_CLIP_PRETRAINED=openai
VISION_EMBEDDING_DIM=512
VISION_DEVICE=cpu
VISION_BATCH_SIZE=32

# Face Recognition
FACE_DETECTOR=retinaface  # retinaface or mtcnn
FACE_RECOGNITION_MODEL=adaface
FACE_EMBEDDING_DIM=512
FACE_SIMILARITY_THRESHOLD=0.6
FACE_DEVICE=cpu

# ============================================================================
# Video Processing
# ============================================================================
MAX_VIDEO_DURATION_SECONDS=600  # 10 minutes
MAX_VIDEO_SIZE_BYTES=1073741824  # 1 GB
ALLOWED_VIDEO_MIMES=video/mp4,video/quicktime,video/x-matroska,video/webm

# Scene Detection
SCENE_DETECTION_METHOD=pyscenedetect  # pyscenedetect or ffmpeg
SCENE_DETECTION_THRESHOLD=30.0
SCENE_MAX_DURATION_SECONDS=90

# Vision Processing
VISION_SAMPLE_FPS=1  # Sample 1 frame per second
VISION_MAX_FRAMES_PER_SCENE=60
VISION_FRAME_SIZE=224  # Resize frames to 224x224

# Audio Extraction
AUDIO_SAMPLE_RATE=16000
AUDIO_CHANNELS=1  # Mono
AUDIO_FORMAT=wav

# ============================================================================
# Rate Limits & Quotas
# ============================================================================
# Free tier limits
FREE_TIER_UPLOADS_PER_DAY=3
FREE_TIER_SEARCH_PER_MINUTE=60

# API rate limits
RATE_LIMIT_PER_IP_REQUESTS=100
RATE_LIMIT_PER_IP_WINDOW_SECONDS=300  # 5 minutes
RATE_LIMIT_PER_USER_REQUESTS=60
RATE_LIMIT_PER_USER_WINDOW_SECONDS=60  # 1 minute

# ============================================================================
# Search Configuration
# ============================================================================
SEARCH_MAX_RESULTS=50
SEARCH_DEFAULT_RESULTS=20
SEARCH_TEXT_WEIGHT=0.5
SEARCH_VISION_WEIGHT=0.35
SEARCH_TAG_WEIGHT=0.15
SEARCH_PERSON_BOOST=0.3

# Signed URL TTL
SIGNED_URL_EXPIRE_SECONDS=600  # 10 minutes

# ============================================================================
# Worker Configuration
# ============================================================================
DRAMATIQ_BROKER=redis
DRAMATIQ_RESULT_BACKEND=redis
DRAMATIQ_THREADS=4
DRAMATIQ_MAX_RETRIES=3
DRAMATIQ_MIN_BACKOFF=15000  # 15 seconds
DRAMATIQ_MAX_BACKOFF=3600000  # 1 hour

# Job timeout (milliseconds)
JOB_TIMEOUT_ASR=1800000  # 30 minutes
JOB_TIMEOUT_VISION=1800000  # 30 minutes
JOB_TIMEOUT_FACE=1800000  # 30 minutes

# ============================================================================
# Observability
# ============================================================================
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
LOG_FORMAT=json  # json or text
ENABLE_OPENTELEMETRY=false
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317

# Prometheus metrics
ENABLE_PROMETHEUS=true
PROMETHEUS_PORT=9090

# Sentry (optional)
SENTRY_DSN=
SENTRY_ENVIRONMENT=development
SENTRY_TRACES_SAMPLE_RATE=0.1

# ============================================================================
# Development
# ============================================================================
DEBUG=true
RELOAD=true
CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

# ============================================================================
# Production (GCP)
# ============================================================================
# GCP_PROJECT_ID=heimdex-prod
# GCP_REGION=us-central1
# CLOUD_SQL_CONNECTION_NAME=heimdex-prod:us-central1:heimdex-db
# SECRET_MANAGER_PROJECT_ID=heimdex-prod

# Cloud Run
# CLOUD_RUN_SERVICE_ACCOUNT=heimdex-api@heimdex-prod.iam.gserviceaccount.com
# CLOUD_RUN_CONCURRENCY=80
# CLOUD_RUN_MAX_INSTANCES=10
# CLOUD_RUN_MEMORY=2Gi
# CLOUD_RUN_CPU=2

# ============================================================================
# Model Paths (Local)
# ============================================================================
MODELS_DIR=./models
WHISPER_MODEL_PATH=./models/whisper
BGE_MODEL_PATH=./models/bge-m3
CLIP_MODEL_PATH=./models/clip
FACE_MODEL_PATH=./models/adaface
